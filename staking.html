<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staking - GPSS</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="staking">
    <!-- Background video -->
    <video autoplay muted loop id="background-video">
        <source src="STAKING.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="container">
        <h1>Staking with GPSS</h1>
        <p>Send Ethereum to our wallet for manual staking. Select your staking term and amount below.</p>

        <label for="term">Select Staking Term:</label>
        <select id="term">
            <option value="3">3 Months</option>
            <option value="6">6 Months</option>
            <option value="12">12 Months</option>
        </select>

        <label for="amount">Amount of Ethereum to Stake (ETH):</label>
        <input type="number" id="amount" placeholder="Enter ETH amount" min="0" step="0.01">

        <button id="connectButton" onclick="connectWallet()">Connect Wallet</button>
        <button id="stakeButton" onclick="stakeEthereum()" disabled>Stake Ethereum</button>
        <button onclick="window.location.href='index.html'">Home</button>

        <div id="status">Wallet not connected</div>
    </div>

    <!-- Use latest ethers.js 5.x version -->
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <script>
        let provider;
        let signer;
        let userAddress;

        // Initialize page
        window.onload = async () => {
            await checkWalletConnection();
            if (window.ethereum) {
                window.ethereum.on('accountsChanged', async () => {
                    await checkWalletConnection();
                });
                window.ethereum.on('chainChanged', async () => {
                    await checkWalletConnection();
                });
            } else {
                updateStatus('Please install MetaMask or use a Web3-compatible browser.');
            }
        };

        // Check if wallet is connected and update UI
        async function checkWalletConnection() {
            const connect ConnectButton = document.getElementById('connectButton');
            const stakeButton = document.getElementById('stakeButton');
            const statusDiv = document.getElementById('status');

            try {
                if (!window.ethereum) {
                    updateStatus('Please install MetaMask or use a Web3-compatible browser.');
                    connectButton.disabled = true;
                    stakeButton.disabled = true;
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                const accounts = await provider.listAccounts();

                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    signer = provider.getSigner();
                    connectButton.textContent = `Connected: ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`;
                    connectButton.disabled = true;
                    stakeButton.disabled = false;
                    updateStatus(`Connected to ${await getNetworkName()}`);
                } else {
                    connectButton.textContent = 'Connect Wallet';
                    connectButton.disabled = false;
                    stakeButton.disabled = true;
                    updateStatus('Wallet not connected');
                }
            } catch (error) {
                console.error('Error checking wallet connection:', error);
                updateStatus('Error connecting to wallet: ' + error.message);
                connectButton.disabled = false;
                stakeButton.disabled = true;
            }
        }

        // Helper to update status div
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        // Get network name for display
        async function getNetworkName() {
            try {
                const network = await provider.getNetwork();
                const chainId = network.chainId;
                const networkNames = {
                    1: 'Ethereum Mainnet',
                    5: 'Goerli Testnet',
                    11155111: 'Sepolia Testnet'
                };
                return networkNames[chainId] || `Unknown Network (Chain ID: ${chainId})`;
            } catch (error) {
                console.error('Error getting network:', error);
                return 'Unknown Network';
            }
        }

        // Connect to wallet
        async function connectWallet() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask or use a Web3-compatible browser.');
                    return;
                }

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await checkWalletConnection();
            } catch (error) {
                console.error('Wallet connection error:', error);
                if (error.code === 4001) {
                    updateStatus('Connection rejected by user.');
                    alert('Wallet connection was rejected.');
                } else if (error.code === -32002) {
                    updateStatus('Please unlock MetaMask or check for pending requests.');
                    alert('MetaMask is locked or has a pending request. Please unlock it.');
                } else {
                    updateStatus('Failed to connect wallet: ' + error.message);
                    alert('Failed to connect wallet: ' + error.message);
                }
            }
        }

        // Stake Ethereum
        async function stakeEthereum() {
            const term = document.getElementById('term').value;
            const amountInput = document.getElementById('amount').value;
            const statusDiv = document.getElementById('status');
            const stakeButton = document.getElementById('stakeButton');

            // Validate input
            if (!amountInput || isNaN(amountInput) || parseFloat(amountInput) <= 0) {
                alert('Please enter a valid ETH amount greater than 0');
                updateStatus('Invalid amount entered');
                return;
            }

            const amount = parseFloat(amountInput);

            // Allow testnets for testing (remove for production)
            const network = await provider
